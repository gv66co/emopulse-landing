<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <title>EMOPULSE - NEURAL INTERFACE V5</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_landmarker@0.10.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@100;300;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --neon: #00f2ff; --stress: #ff3e3e; --glass: rgba(0, 10, 20, 0.7); }
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Inter', sans-serif; color: white; }

        /* Futuristinis Layout pagal tavo nuotrauką */
        #ui-container {
            position: absolute; inset: 0; z-index: 10; pointer-events: none;
            display: grid; grid-template-columns: 400px 1fr 400px;
            grid-template-rows: 80px 1fr 250px; padding: 40px; gap: 20px;
        }

        .header { grid-column: 1 / 4; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0, 242, 255, 0.2); }
        .logo { font-family: 'Orbitron'; letter-spacing: 10px; font-size: 22px; color: var(--neon); text-shadow: 0 0 15px var(--neon); }

        .panel { 
            background: var(--glass); backdrop-filter: blur(30px); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; 
            padding: 25px; pointer-events: auto;
        }

        /* Kameros vaizdas su Face Mesh */
        .video-wrap { position: relative; width: 100%; height: 220px; border-radius: 20px; overflow: hidden; border: 1px solid var(--neon); }
        #webcam { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); filter: brightness(0.8) contrast(1.2); }
        canvas#output_canvas { position: absolute; inset: 0; width: 100%; height: 100%; transform: scaleX(-1); }

        /* Apatinės kortelės */
        .bottom-grid { grid-column: 1 / 4; grid-row: 3; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; padding: 20px; }
        .label { font-size: 10px; letter-spacing: 2px; opacity: 0.5; text-transform: uppercase; }
        .value { font-family: 'Orbitron'; font-size: 24px; color: var(--neon); margin-top: 10px; }

        /* Emocinis Summary */
        .summary-box { border-left: 4px solid var(--neon); }
        .tag { display: inline-block; padding: 4px 10px; background: rgba(0, 242, 255, 0.1); border-radius: 10px; font-size: 11px; margin: 2px; color: var(--neon); }
    </style>
</head>
<body>

    <div id="ui-container">
        <div class="header">
            <div class="logo">EMOPULSE</div>
            <div style="font-size: 12px; opacity: 0.6;">SYSTEM STATUS: <span style="color:var(--neon)">ANALYZING</span></div>
        </div>

        <div class="panel">
            <div class="video-wrap">
                <video id="webcam" autoplay playsinline></video>
                <canvas id="output_canvas"></canvas>
            </div>
            <div style="margin-top: 30px;">
                <div class="label">Neural Drift</div>
                <div class="value" id="drift_val">+0.000</div>
                <div style="width: 100%; height: 2px; background: rgba(255,255,255,0.1); margin-top: 10px;">
                    <div id="drift_bar" style="width: 50%; height: 100%; background: var(--neon); box-shadow: 0 0 10px var(--neon);"></div>
                </div>
            </div>
        </div>

        <div id="three-container"></div>

        <div class="panel summary-box">
            <div class="label">Emotional Summary</div>
            <div id="status_text" style="font-size: 22px; margin: 15px 0;">Skenuojamas veidas...</div>
            <div id="tags_container">
                <span class="tag">#neutral</span>
            </div>
        </div>

        <div class="bottom-grid">
            <div class="card">
                <div class="label">Emopulse Score</div>
                <div class="value">76 <small style="font-size: 12px; opacity:0.5">/100</small></div>
            </div>
            <div class="card">
                <div class="label">Energy</div>
                <div class="value" id="energy_val">0,66 <small style="font-size: 12px; color:var(--neon)">rising</small></div>
            </div>
            <div class="card">
                <div class="label">Stress Risk</div>
                <div class="value" id="stress_val" style="color: #44ff44;">Low</div>
            </div>
            <div class="card">
                <div class="label">Stability</div>
                <div class="value">112° <small style="font-size: 10px; opacity:0.5">toward Calm</small></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { FaceLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/face_landmarker@0.10.0";

        let faceLandmarker;
        let video = document.getElementById("webcam");
        const canvasElement = document.getElementById("output_canvas");
        const canvasCtx = canvasElement.getContext("2d");

        // Inicializuojame MediaPipe veido sekimą
        async function setupFaceMesh() {
            const filesetResolver = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/face_landmarker@0.10.0/wasm");
            faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`, delegate: "GPU" },
                outputFaceBlendshapes: true,
                runningMode: "VIDEO",
                numFaces: 1
            });
            startCamera();
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
            });
        }

        async function predictWebcam() {
            canvasElement.width = video.videoWidth;
            canvasElement.height = video.videoHeight;
            
            let lastVideoTime = -1;
            async function render() {
                if (video.currentTime !== lastVideoTime) {
                    const results = faceLandmarker.detectForVideo(video, performance.now());
                    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                    
                    if (results.faceLandmarks) {
                        const drawingUtils = new DrawingUtils(canvasCtx);
                        for (const landmarks of results.faceLandmarks) {
                            // Piešiame futuristinį tinklą ant veido
                            drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_TESSELATION, { color: "#00f2ff33", lineWidth: 1 });
                            drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_RIGHT_EYE, { color: "#00f2ff" });
                            drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_LEFT_EYE, { color: "#00f2ff" });
                        }

                        // EMOCIJŲ ANALIZĖ pagal veido raumenis
                        if (results.faceBlendshapes && results.faceBlendshapes[0]) {
                            analyzeEmotions(results.faceBlendshapes[0].categories);
                        }
                    }
                }
                requestAnimationFrame(render);
            }
            render();
        }

        function analyzeEmotions(shapes) {
            // Surandame pagrindines formas (pvz. šypsena, antakių kėlimas)
            const smile = shapes.find(s => s.categoryName === "browInnerUp")?.score || 0;
            const stress = shapes.find(s => s.categoryName === "browDownLeft")?.score || 0;
            
            const driftEl = document.getElementById('drift_val');
            const statusEl = document.getElementById('status_text');
            const stressEl = document.getElementById('stress_val');

            if (stress > 0.3) {
                statusEl.innerText = "Elevated Stress Detected";
                driftEl.innerText = "+" + (stress * 5).toFixed(3);
                stressEl.innerText = "HIGH";
                stressEl.style.color = "#ff3e3e";
            } else {
                statusEl.innerText = "Calm Focused Energy";
                driftEl.innerText = "+0.842";
                stressEl.innerText = "Low";
                stressEl.style.color = "#44ff44";
            }
        }

        setupFaceMesh();
    </script>
</body>
</html>
