<!DOCTYPE html>
<html lang="en" class="emopulse-theme">
<head>
  <meta charset="UTF-8">
  <title>Emopulse – Emotional AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS -->
  <link rel="stylesheet" href="styles.css">

  <!-- Icons & PWA -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <meta name="theme-color" content="#0b0f1c">
  <link rel="manifest" href="manifest.json">
</head>
<body class="emopulse-theme">
  <!-- NAVBAR -->
  <header class="emo-page-header">
    <div class="emo-header-inner">
      <div class="emo-logo-block">
        <div class="emo-logo-mark"></div>
        <div class="emo-logo-text">
          <span class="emo-logo-title">Emopulse</span>
          <span class="emo-logo-sub">Emotional AI that sees, feels, understands</span>
        </div>
      </div>
      <button class="ai-coach-button" id="askNatashaButton">
        <div class="ai-coach-pulse"></div>
        <span>Ask Natasha</span>
      </button>
    </div>
  </header>

  <main class="emo-main">
    <!-- HERO / LIVE DEMO BAND -->
    <section class="hero-section hero-gradient-wave section-stagger">
      <div class="hero-grid">
        <!-- Left: Aura + Drift -->
        <div class="hero-visual">
          <div class="emo-card">
            <div class="emo-card-header">
              <div class="emo-card-title">Live emotional radar</div>
              <span class="emo-pill emo-tag-soft" id="demoModePill">Live session</span>
            </div>
            <div class="emo-hero-visual-row">
              <!-- Aura -->
              <div class="emo-aura-wrapper calm" id="heroAura">
                <div class="emo-aura-ring"></div>
                <div class="emo-aura-ring"></div>
                <div class="emo-aura-ring"></div>
                <div class="emo-aura-core"></div>
              </div>

              <!-- Drift spiral -->
              <div class="drift-core">
                <div class="drift-spiral-shell">
                  <div class="drift-layer"></div>
                  <div class="drift-layer"></div>
                  <div class="drift-layer"></div>
                  <div class="drift-spiral calm strong" id="driftSpiral"></div>
                  <div class="drift-spiral-orbit">
                    <div class="drift-spiral-dot" id="driftDot"></div>
                  </div>
                </div>
                <div>
                  <div class="drift-label">Emotional drift</div>
                  <div class="drift-value positive" id="driftValue">+12%</div>
                  <div class="drift-caption" id="driftCaption">Calmness increasing</div>
                </div>
              </div>
            </div>

            <div class="scenario-buttons">
              <button class="scenario-button" data-scenario="smile">Smile</button>
              <button class="scenario-button" data-scenario="neutral">Neutral</button>
              <button class="scenario-button" data-scenario="stress">Stress</button>
              <button class="scenario-button" data-scenario="high-stress">High stress</button>
              <button class="scenario-button" data-scenario="calm">Calm mode</button>
              <button class="scenario-button" data-scenario="focus">Focus mode</button>
            </div>
          </div>
        </div>

        <!-- Right: Copy + Score + Weather -->
        <div class="hero-copy">
          <div class="emo-card">
            <div class="emo-card-header">
              <div class="emo-card-title">Emotional AI</div>
              <span class="emo-pill emo-tag-soft">Live ● Signals + LLM-ready</span>
            </div>
            <h1 class="hero-title reveal-on-scroll">
              Real-time emotional intelligence<br>
              from your camera & micro-signals
            </h1>
            <p class="hero-subtitle reveal-on-scroll">
              Emopulse transforms pulse, micro-signals, and context into a living emotional dashboard:
              drift, stability, risk, and narrative – in seconds.
            </p>
            <div class="hero-cta-row">
              <button class="ai-coach-button cta-pulse button-glow reveal-on-scroll" id="startLiveButton">
                <div class="ai-coach-pulse"></div>
                <span>Start live scan</span>
              </button>
              <div class="emotional-signature-pill">
                <div class="emotional-signature-dot"></div>
                <span id="emotionalSignatureText">Today’s emotional signature: Calm Focused Energy</span>
              </div>
            </div>
          </div>

          <div class="hero-metrics-row">
            <div class="emopulse-score-card card-premium reveal-on-scroll">
              <div class="emopulse-score-label">Emopulse Score</div>
              <div class="emopulse-score-value" id="emopulseScoreValue">78 / 100</div>
              <div class="emopulse-score-bar">
                <div class="emopulse-score-bar-fill" id="emopulseScoreBarFill"></div>
              </div>
            </div>

            <div class="emotional-weather-card card-premium reveal-on-scroll">
              <div class="emo-card-header">
                <div class="emo-card-title">Emotional weather</div>
              </div>
              <div class="emo-flex emo-flex-between">
                <div>
                  <div class="emotional-weather-main" id="emotionalWeatherMain">
                    Clear with a chance of focus
                  </div>
                  <div class="emotional-weather-tag" id="emotionalWeatherTag">
                    short-term outlook: low stress, rising clarity
                  </div>
                </div>
                <div class="emotional-weather-icon calm" id="emotionalWeatherIcon">
                  <!-- icon later -->
                </div>
              </div>
            </div>
          </div>

          <div class="privacy-banner">
            We never store your data. All processing is real-time. You stay in control.
          </div>
        </div>
      </div>
    </section>

    <!-- MINI DASHBOARD LAYER -->
    <section class="section-block section-stagger" id="mini-dashboard">
      <h2>Mini dashboard</h2>
      <div class="mini-dashboard">
        <div class="mini-metric-card">
          <div class="mini-metric-label">Pulse</div>
          <div class="mini-metric-value" id="pulseValue">74 bpm</div>
          <div class="mini-metric-pill" id="pulseQuality">Signal quality: high</div>
        </div>
        <div class="mini-metric-card">
          <div class="mini-metric-label">Emotion</div>
          <div class="mini-metric-value" id="miniEmotionValue">Calm</div>
          <div class="mini-metric-pill" id="miniValence">Valence: positive</div>
        </div>
        <div class="mini-metric-card">
          <div class="mini-metric-label">Confidence</div>
          <div class="mini-metric-value" id="confidenceValue">91%</div>
          <div class="mini-metric-pill" id="patternStability">Stable pattern</div>
        </div>
        <div class="mini-metric-card">
          <div class="mini-metric-label">Stress risk</div>
          <div class="mini-metric-value" id="stressRiskValue">18 / 100</div>
          <div class="mini-metric-pill" id="stressRiskLabel">Low & contained</div>
        </div>
        <div class="mini-metric-card">
          <div class="mini-metric-label">Trend</div>
          <canvas id="emotionTrend" width="220" height="60"></canvas>
        </div>
      </div>
    </section>

    <!-- MOOD MAP + TIMELINE -->
    <section class="section-block section-stagger" id="mood-map-timeline">
      <h2>Emotional map & timeline</h2>
      <div class="emo-grid emo-grid-2">
        <!-- Mood Map -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Mood map</div>
            <span class="emo-pill emo-tag-soft">Valence / arousal</span>
          </div>
          <div class="mood-map">
            <div class="mood-map-grid"></div>
            <div class="mood-map-axis-label top">High arousal</div>
            <div class="mood-map-axis-label bottom">Low arousal</div>
            <div class="mood-map-axis-label left">Negative</div>
            <div class="mood-map-axis-label right">Positive</div>
            <div class="mood-map-dot" id="moodMapDot" style="left: 65%; top: 42%;"></div>
          </div>
        </div>

        <!-- Timeline -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Emotion timeline</div>
            <span class="emo-pill emo-tag-soft">Last 60 seconds</span>
          </div>
          <div class="emotion-timeline">
            <div class="emotion-timeline-track">
              <div class="emotion-timeline-progress" id="emotionTimelineProgress"></div>
              <div class="emotion-timeline-emotion-dot calm" id="timelineDot1" style="left: 10%;"></div>
              <div class="emotion-timeline-emotion-dot focus" id="timelineDot2" style="left: 35%;"></div>
              <div class="emotion-timeline-emotion-dot stress" id="timelineDot3" style="left: 58%;"></div>
              <div class="emotion-timeline-emotion-dot calm" id="timelineDot4" style="left: 82%;"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- EMOTION RINGS + HEATMAP -->
    <section class="section-block section-stagger" id="rings-heatmap">
      <h2>Rings & heatmap</h2>
      <div class="emo-grid emo-grid-2">
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Emotion rings</div>
            <span class="emo-pill emo-tag-soft">Calm / Focus / Stress</span>
          </div>
          <div class="emotion-rings animate">
            <div class="emotion-ring calm" id="ringCalm"></div>
            <div class="emotion-ring focus" id="ringFocus"></div>
            <div class="emotion-ring stress" id="ringStress"></div>
            <div class="emotion-ring joy" id="ringJoy"></div>
          </div>
        </div>

        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Emotion heatmap</div>
            <span class="emo-pill emo-tag-soft">Intensity over time</span>
          </div>
          <div class="emotion-heatmap" id="emotionHeatmap">
            <!-- initial pattern -->
            <div class="emotion-heatmap-cell low"></div>
            <div class="emotion-heatmap-cell low"></div>
            <div class="emotion-heatmap-cell medium"></div>
            <div class="emotion-heatmap-cell high"></div>
            <div class="emotion-heatmap-cell medium"></div>
            <div class="emotion-heatmap-cell low"></div>
            <div class="emotion-heatmap-cell low"></div>
            <div class="emotion-heatmap-cell medium"></div>
            <div class="emotion-heatmap-cell high"></div>
            <div class="emotion-heatmap-cell high"></div>
            <div class="emotion-heatmap-cell medium"></div>
            <div class="emotion-heatmap-cell low"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- EXPERIENCE LAYER: STORY, CHALLENGE, STREAKS, MILESTONES -->
    <section class="section-block section-stagger" id="experience-layer">
      <h2>Experience layer</h2>
      <div class="emo-grid emo-grid-2">
        <!-- Emotion Story -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Emotion story</div>
          </div>
          <div class="emotion-challenge">
            <div class="emotion-challenge-label">Session narrative</div>
            <p id="storyLine1">Your emotional journey today began in calmness.</p>
            <p id="storyLine2">You transitioned into focused clarity.</p>
            <p id="storyLine3">A brief stress spike appeared but resolved quickly.</p>
          </div>
        </div>

        <!-- Emotion Challenge -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Emotion challenge</div>
          </div>
          <div class="emotion-challenge">
            <div class="emotion-challenge-label">Challenge</div>
            <p id="challengeText">Hold calmness for 60 seconds.</p>
            <button class="scenario-button" id="challengeButton">Start challenge</button>
          </div>
        </div>
      </div>

      <div class="emo-grid emo-grid-2" style="margin-top: 16px;">
        <!-- Emotion streaks -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Emotion streaks</div>
          </div>
          <div class="emotion-streaks">
            <div class="streak-item">
              <span class="streak-label">Calm streak</span>
              <span class="streak-value" id="calmStreak">3 days</span>
            </div>
            <div class="streak-item">
              <span class="streak-label">Focus streak</span>
              <span class="streak-value" id="focusStreak">1 day</span>
            </div>
          </div>
        </div>

        <!-- Emotional milestones -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Emotional milestones</div>
          </div>
          <div class="emotion-badges">
            <div class="emotion-badge calm" id="badgeCalm">Calm Master</div>
            <div class="emotion-badge focus" id="badgeFocus">Focus Achiever</div>
            <div class="emotion-badge stress" id="badgeStress">Stress Recovery</div>
          </div>
        </div>
      </div>
    </section>

    <!-- AI COACH + INSIGHTS -->
    <section class="section-block section-stagger" id="ai-coach-layer">
      <h2>AI insights & coach</h2>
      <div class="emo-grid emo-grid-2">
        <!-- AI Reflection -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">AI reflection</div>
          </div>
          <div class="emotion-challenge">
            <p id="aiReflectionLine1">“Your emotional flow today shows resilience.”</p>
            <p id="aiReflectionLine2">“You adapted well to stress fluctuations.”</p>
          </div>
        </div>

        <!-- AI Mood Coach -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">AI mood coach</div>
          </div>
          <p class="hero-subtitle" style="margin-bottom: 12px;">
            Ask: <em>“What should I do now?”</em> and get a short, emotionally precise suggestion.
          </p>
          <button class="ai-coach-button" id="aiCoachButton">
            <div class="ai-coach-pulse"></div>
            <span>What should I do now?</span>
          </button>
          <p id="aiCoachOutput" style="margin-top: 10px; font-size: 13px; opacity: 0.9;"></p>
        </div>
      </div>
    </section>

    <!-- EMOTIONAL COMPASS & TAGS & MINI REPORT -->
    <section class="section-block section-stagger" id="compass-tags-report">
      <h2>Compass, tags & mini report</h2>
      <div class="emo-grid emo-grid-3">
        <!-- Compass -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Emotional compass</div>
          </div>
          <div class="focus-mode-overlay">
            <div class="session-tags" id="compassTags">
              <span class="session-tag">Calm</span>
              <span class="session-tag">Joy</span>
              <span class="session-tag">Focus</span>
              <span class="session-tag">Stress</span>
            </div>
            <p style="margin-top: 10px; font-size: 13px;" id="compassHeading">
              Current heading: calm + focus, low stress, high stability.
            </p>
          </div>
        </div>

        <!-- Session tags -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Session tags</div>
          </div>
          <div class="session-tags" id="sessionTags">
            <span class="session-tag">calm</span>
            <span class="session-tag">focused</span>
            <span class="session-tag">stable</span>
            <span class="session-tag">low stress</span>
          </div>
        </div>

        <!-- Mini report -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Mini emotional report</div>
          </div>
          <div class="mini-report">
            <div class="report-item">
              <span class="label">Peak calm</span>
              <span class="value" id="peakCalm">82%</span>
            </div>
            <div class="report-item">
              <span class="label">Focus duration</span>
              <span class="value" id="focusDuration">14 min</span>
            </div>
            <div class="report-item">
              <span class="label">Stress recovery</span>
              <span class="value" id="stressRecovery">Fast</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- EMOTIONAL AURA / DNA / TRAIL / BREATH -->
    <section class="section-block section-stagger" id="visual-layer">
      <h2>Visual emotional layer</h2>
      <div class="emo-grid emo-grid-2">
        <!-- Aura + DNA -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Emotional aura & DNA</div>
          </div>
          <div class="emo-flex" style="gap: 18px; align-items: center;">
            <div class="emo-aura-wrapper calm" id="emotionalAura">
              <div class="emo-aura-ring"></div>
              <div class="emo-aura-ring"></div>
              <div class="emo-aura-ring"></div>
              <div class="emo-aura-core"></div>
            </div>
            <div class="emotion-dna" id="emotionDna">
              <div class="dna-strand">A — Calm</div>
              <div class="dna-strand">T — Focus</div>
              <div class="dna-strand">G — Stability</div>
              <div class="dna-strand">C — Recovery</div>
            </div>
          </div>
        </div>

        <!-- Trail + Calm Breath -->
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Trail & calm breath</div>
          </div>
          <div class="emotion-trail" id="emotionTrail">
            <div class="trail-step">Calm → Focus</div>
            <div class="trail-step">Focus → Stress</div>
            <div class="trail-step">Stress → Calm</div>
          </div>
          <div class="calm-breath" style="margin-top: 14px;">
            <div class="breath-circle"></div>
            <p class="breath-instruction">Inhale… Exhale…</p>
          </div>
        </div>
      </div>
    </section>

    <!-- NATASHA SIGNATURE + HORIZON -->
    <section class="section-block section-stagger" id="natasha-layer">
      <h2>Natasha layer</h2>
      <div class="emo-grid emo-grid-2">
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Natasha signature</div>
          </div>
          <div class="emotion-challenge">
            <p>Soft intuition. Deep clarity. Emotional precision.</p>
            <p>Your companion’s unique emotional fingerprint.</p>
          </div>
        </div>
        <div class="emo-card">
          <div class="emo-card-header">
            <div class="emo-card-title">Emotional horizon</div>
          </div>
          <div class="emotion-challenge">
            <p>Your emotional trajectory is expanding toward clarity.</p>
            <p>Long-term trend: steady growth in calmness and focus.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- LIVE EMOTION SCAN + RADAR -->
    <section class="section-block section-stagger emotion-section" id="live-emotion-scan">
      <h2>Live Emotion Scan</h2>

      <!-- Camera (hidden / stylable) -->
      <video id="camera" autoplay playsinline style="display:none;"></video>

      <div class="emotion-layout">
        <!-- Left – primary emotion -->
        <div class="emotion-panel">
          <div id="emotionLabel">Waiting for data...</div>
          <div id="emotionIntensity">Intensity: 0%</div>
          <div id="emotionHistoryTitle">Recent emotions:</div>
          <ul id="emotionHistory"></ul>
        </div>

        <!-- Right – radar -->
        <div class="emotion-radar-wrapper">
          <canvas id="emotionRadar" width="300" height="300"></canvas>
        </div>
      </div>

      <!-- Simple text output -->
      <div id="emotionOutput" style="margin-top: 12px; font-size: 13px; opacity: 0.8;">
        Waiting for data...
      </div>
    </section>

    <!-- ROADMAP -->
    <section class="section-block section-stagger" id="roadmap">
      <h2>Roadmap</h2>
      <div class="emo-card">
        <div class="emo-card-header">
          <div class="emo-card-title">From live demo to emotional OS</div>
        </div>
        <div class="emo-grid">
          <div class="roadmap-phase">
            <div class="roadmap-phase-dot"></div>
            <span>Phase 1: PPG + LLM (done)</span>
          </div>
          <div class="roadmap-phase">
            <div class="roadmap-phase-dot"></div>
            <span>Phase 2: Face + Voice (in progress)</span>
          </div>
          <div class="roadmap-phase">
            <div class="roadmap-phase-dot"></div>
            <span>Phase 3: Multimodal fusion</span>
          </div>
          <div class="roadmap-phase">
            <div class="roadmap-phase-dot"></div>
            <span>Phase 4: AI Coach</span>
          </div>
          <div class="roadmap-phase">
            <div class="roadmap-phase-dot"></div>
            <span>Phase 5: Emotional OS platform</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="emo-page-footer footer reveal-on-scroll">
    <div class="emo-footer-inner footer-columns">
      <div>
        <h4>Emopulse</h4>
        <a href="#live-emotion-scan">Live scan</a><br>
        <a href="#ai-coach-layer">AI Coach</a>
      </div>
      <div>
        <h4>Principles</h4>
        <a>Privacy-first</a><br>
        <a>Emotional clarity</a>
      </div>
    </div>
    <div class="footer-bottom">
      © Emopulse · Emotional AI prototype evolving into a platform.
    </div>
  </footer>

  <!-- INLINE SCRIPT: live logic, webcam, voice, visuals -->
  <script>
    // ===== GLOBAL STATE =====================================================
    const state = {
      running: false,
      currentEmotion: 'Calm',
      intensity: 0.3,
      valence: 0.6,  // 0 negative, 1 positive
      arousal: 0.4,  // 0 low, 1 high
      score: 78,
      stressRisk: 18,
      history: [],
      trend: [],
      challengeActive: false,
      challengeStart: null,
      speechRecognition: null,
      recognizing: false
    };

    // Utility: clamp
    function clamp(v, min, max) {
      return Math.min(max, Math.max(min, v));
    }

    // ===== DOM REFERENCES ===================================================
    const emotionLabelEl = document.getElementById('emotionLabel');
    const emotionIntensityEl = document.getElementById('emotionIntensity');
    const emotionHistoryEl = document.getElementById('emotionHistory');
    const emotionOutputEl = document.getElementById('emotionOutput');
    const emotionRadarCanvas = document.getElementById('emotionRadar');
    const radarCtx = emotionRadarCanvas.getContext('2d');

    const moodMapDot = document.getElementById('moodMapDot');
    const emopulseScoreValue = document.getElementById('emopulseScoreValue');
    const emopulseScoreBarFill = document.getElementById('emopulseScoreBarFill');

    const stressRiskValue = document.getElementById('stressRiskValue');
    const stressRiskLabel = document.getElementById('stressRiskLabel');

    const miniEmotionValue = document.getElementById('miniEmotionValue');
    const miniValence = document.getElementById('miniValence');
    const confidenceValue = document.getElementById('confidenceValue');
    const patternStability = document.getElementById('patternStability');
    const pulseValue = document.getElementById('pulseValue');
    const pulseQuality = document.getElementById('pulseQuality');

    const emotionalWeatherMain = document.getElementById('emotionalWeatherMain');
    const emotionalWeatherTag = document.getElementById('emotionalWeatherTag');
    const emotionalSignatureText = document.getElementById('emotionalSignatureText');

    const heroAura = document.getElementById('heroAura');
    const emotionalAura = document.getElementById('emotionalAura');
    const ringCalm = document.getElementById('ringCalm');
    const ringFocus = document.getElementById('ringFocus');
    const ringStress = document.getElementById('ringStress');
    const ringJoy = document.getElementById('ringJoy');

    const storyLine1 = document.getElementById('storyLine1');
    const storyLine2 = document.getElementById('storyLine2');
    const storyLine3 = document.getElementById('storyLine3');

    const peakCalmEl = document.getElementById('peakCalm');
    const focusDurationEl = document.getElementById('focusDuration');
    const stressRecoveryEl = document.getElementById('stressRecovery');

    const compassHeading = document.getElementById('compassHeading');
    const sessionTags = document.getElementById('sessionTags');
    const compassTags = document.getElementById('compassTags');

    const aiReflectionLine1 = document.getElementById('aiReflectionLine1');
    const aiReflectionLine2 = document.getElementById('aiReflectionLine2');
    const aiCoachOutput = document.getElementById('aiCoachOutput');

    const driftValueEl = document.getElementById('driftValue');
    const driftCaptionEl = document.getElementById('driftCaption');
    const driftSpiralEl = document.getElementById('driftSpiral');

    const emotionTrendCanvas = document.getElementById('emotionTrend');
    const trendCtx = emotionTrendCanvas.getContext('2d');

    const startLiveButton = document.getElementById('startLiveButton');
    const askNatashaButton = document.getElementById('askNatashaButton');
    const aiCoachButton = document.getElementById('aiCoachButton');
    const cameraVideo = document.getElementById('camera');
    const challengeButton = document.getElementById('challengeButton');

    // ===== EMOTION UPDATE / SIMULATION ======================================
    const EMOTIONS = ['Calm', 'Focus', 'Stress', 'Joy', 'Neutral'];

    function applyScenario(scenario) {
      if (scenario === 'smile') {
        state.currentEmotion = 'Joy';
        state.valence = 0.9;
        state.arousal = 0.5;
        state.intensity = 0.7;
      } else if (scenario === 'neutral') {
        state.currentEmotion = 'Neutral';
        state.valence = 0.5;
        state.arousal = 0.4;
        state.intensity = 0.3;
      } else if (scenario === 'stress') {
        state.currentEmotion = 'Stress';
        state.valence = 0.3;
        state.arousal = 0.7;
        state.intensity = 0.8;
      } else if (scenario === 'high-stress') {
        state.currentEmotion = 'Stress';
        state.valence = 0.2;
        state.arousal = 0.9;
        state.intensity = 0.95;
      } else if (scenario === 'calm') {
        state.currentEmotion = 'Calm';
        state.valence = 0.7;
        state.arousal = 0.3;
        state.intensity = 0.5;
      } else if (scenario === 'focus') {
        state.currentEmotion = 'Focus';
        state.valence = 0.8;
        state.arousal = 0.6;
        state.intensity = 0.6;
      }
      pushHistory('scenario:' + scenario);
      refreshUI();
    }

    function pushHistory(source) {
      const entry = {
        emotion: state.currentEmotion,
        intensity: state.intensity,
        valence: state.valence,
        arousal: state.arousal,
        time: new Date(),
        source
      };
      state.history.unshift(entry);
      if (state.history.length > 10) state.history.pop();
      state.trend.push(entry.intensity);
      if (state.trend.length > 40) state.trend.shift();
    }

    function simulateStep() {
      if (!state.running) return;

      // slight random walk
      const deltaVal = (Math.random() - 0.5) * 0.05;
      const deltaAro = (Math.random() - 0.5) * 0.05;
      const deltaInt = (Math.random() - 0.5) * 0.08;

      state.valence = clamp(state.valence + deltaVal, 0, 1);
      state.arousal = clamp(state.arousal + deltaAro, 0, 1);
      state.intensity = clamp(state.intensity + deltaInt, 0, 1);

      // derive emotion label from valence/arousal
      if (state.valence > 0.7 && state.arousal < 0.5) {
        state.currentEmotion = 'Calm';
      } else if (state.valence > 0.7 && state.arousal >= 0.5) {
        state.currentEmotion = 'Joy';
      } else if (state.valence > 0.5 && state.arousal >= 0.5) {
        state.currentEmotion = 'Focus';
      } else if (state.valence < 0.4 && state.arousal >= 0.6) {
        state.currentEmotion = 'Stress';
      } else {
        state.currentEmotion = 'Neutral';
      }

      // update score & risk
      const calmFactor = state.currentEmotion === 'Calm' || state.currentEmotion === 'Joy' ? 1 : 0;
      const stressFactor = state.currentEmotion === 'Stress' ? 1 : 0;
      state.score = clamp(state.score + (calmFactor * 2 - stressFactor * 3), 40, 98);
      state.stressRisk = clamp(state.stressRisk + (stressFactor * 4 - calmFactor * 2), 5, 90);

      pushHistory('live');
      refreshUI();
    }

    // ===== UI BIND ==========================================================
    function refreshUI() {
      // Primary labels
      emotionLabelEl.textContent = state.currentEmotion;
      emotionIntensityEl.textContent = 'Intensity: ' + Math.round(state.intensity * 100) + '%';
      emotionOutputEl.textContent =
        'Current: ' + state.currentEmotion +
        ' · valence ' + state.valence.toFixed(2) +
        ' · arousal ' + state.arousal.toFixed(2);

      // History list
      emotionHistoryEl.innerHTML = '';
      state.history.forEach((h) => {
        const li = document.createElement('li');
        li.textContent = `${h.emotion} · ${Math.round(h.intensity * 100)}% (${h.source})`;
        emotionHistoryEl.appendChild(li);
      });

      // Mood map position
      moodMapDot.style.left = (state.valence * 100) + '%';
      moodMapDot.style.top = ((1 - state.arousal) * 100) + '%';

      // Score & bar
      emopulseScoreValue.textContent = Math.round(state.score) + ' / 100';
      emopulseScoreBarFill.style.width = Math.round(state.score) + '%';

      // Stress
      stressRiskValue.textContent = Math.round(state.stressRisk) + ' / 100';
      if (state.stressRisk < 30) {
        stressRiskLabel.textContent = 'Low & contained';
      } else if (state.stressRisk < 60) {
        stressRiskLabel.textContent = 'Moderate – watch patterns';
      } else {
        stressRiskLabel.textContent = 'Elevated – consider recovery';
      }

      // Mini dashboard fields
      miniEmotionValue.textContent = state.currentEmotion;
      miniValence.textContent =
        'Valence: ' + (state.valence > 0.6 ? 'positive' : state.valence < 0.4 ? 'negative' : 'balanced');
      confidenceValue.textContent = Math.round((0.7 + state.intensity * 0.3) * 100) + '%';
      patternStability.textContent = state.intensity < 0.5 ? 'Stable pattern' : 'Dynamic but coherent';

      // Fake pulse
      const basePulse = 68;
      const pulse = basePulse + Math.round((state.arousal - 0.4) * 40);
      pulseValue.textContent = clamp(pulse, 52, 110) + ' bpm';
      pulseQuality.textContent = 'Signal quality: high';

      // Weather + signature
      if (state.currentEmotion === 'Calm') {
        emotionalWeatherMain.textContent = 'Clear with a chance of focus';
        emotionalWeatherTag.textContent = 'short-term outlook: low stress, rising clarity';
        emotionalSignatureText.textContent = 'Today’s emotional signature: Calm Focused Energy';
      } else if (state.currentEmotion === 'Stress') {
        emotionalWeatherMain.textContent = 'Storm pockets with recovery gaps';
        emotionalWeatherTag.textContent = 'short-term outlook: elevated stress, prioritize grounding';
        emotionalSignatureText.textContent = 'Today’s emotional signature: Stress with recovery windows';
      } else if (state.currentEmotion === 'Focus') {
        emotionalWeatherMain.textContent = 'Focused skies, low distraction winds';
        emotionalWeatherTag.textContent = 'short-term outlook: high clarity, moderate tension';
        emotionalSignatureText.textContent = 'Today’s emotional signature: Deep Focused Flow';
      } else if (state.currentEmotion === 'Joy') {
        emotionalWeatherMain.textContent = 'Warm with bursts of joy';
        emotionalWeatherTag.textContent = 'short-term outlook: high energy, stable mood';
        emotionalSignatureText.textContent = 'Today’s emotional signature: Uplifted Joyful Presence';
      } else {
        emotionalWeatherMain.textContent = 'Mixed patterns, stabilising';
        emotionalWeatherTag.textContent = 'short-term outlook: evolving, watch for stress/calm swings';
        emotionalSignatureText.textContent = 'Today’s emotional signature: Transitional Emotional State';
      }

      // Aura classes
      [heroAura, emotionalAura].forEach((el) => {
        if (!el) return;
        el.classList.remove('calm', 'focus', 'stress', 'joy', 'neutral');
        const cls = state.currentEmotion.toLowerCase();
        el.classList.add(cls.includes('focus') ? 'focus' : cls.includes('stress') ? 'stress' :
          cls.includes('joy') ? 'joy' :
          cls.includes('calm') ? 'calm' : 'neutral');
      });

      // Rings highlight
      ringCalm.style.opacity = state.currentEmotion === 'Calm' ? 1 : 0.4;
      ringFocus.style.opacity = state.currentEmotion === 'Focus' ? 1 : 0.4;
      ringStress.style.opacity = state.currentEmotion === 'Stress' ? 1 : 0.4;
      ringJoy.style.opacity = state.currentEmotion === 'Joy' ? 1 : 0.4;

      // Drift
      const drift = (state.valence - 0.5) * 40 - (state.stressRisk - 20) * 0.15;
      driftValueEl.textContent = (drift >= 0 ? '+' : '') + drift.toFixed(1) + '%';
      driftCaptionEl.textContent =
        drift > 5 ? 'Calmness increasing' :
        drift < -5 ? 'Stress pressure building' :
        'Subtle micro-shifts detected';
      driftSpiralEl.classList.toggle('strong', Math.abs(drift) > 10);

      // Story (simple adaptation)
      storyLine1.textContent =
        state.currentEmotion === 'Stress'
          ? 'Your emotional journey shows stress pockets emerging.'
          : 'Your emotional journey is anchored in calmness.';
      storyLine2.textContent =
        state.currentEmotion === 'Focus'
          ? 'You are entering a focused, task-ready state.'
          : 'You maintain capacity for clarity and adjustment.';
      storyLine3.textContent =
        state.stressRisk > 50
          ? 'Stress spikes are visible – recovery rituals would help now.'
          : 'Any stress spikes resolve quickly – resilience is present.';

      // Mini-report
      peakCalmEl.textContent = Math.round(60 + state.valence * 40) + '%';
      focusDurationEl.textContent = Math.round(5 + state.intensity * 20) + ' min';
      stressRecoveryEl.textContent =
        state.stressRisk < 30 ? 'Fast' : state.stressRisk < 60 ? 'Moderate' : 'Slower – needs support';

      // Compass + tags
      compassHeading.textContent =
        `Current heading: ${state.currentEmotion.toLowerCase()} · valence ${state.valence.toFixed(2)}, arousal ${state.arousal.toFixed(2)}.`;
      // tags can be later dynamic

      // AI reflection (placeholder logic)
      aiReflectionLine1.textContent =
        state.stressRisk < 40
          ? '“Your system shows solid emotional resilience today.”'
          : '“Your system is carrying higher stress load than usual.”';
      aiReflectionLine2.textContent =
        state.currentEmotion === 'Stress'
          ? '“Micro-pauses and grounding could shift your curve.”'
          : '“You’re adapting effectively to fluctuations.”';

      // Draw visuals
      drawRadar();
      drawTrend();
    }

    // ===== RADAR DRAW =======================================================
    function drawRadar() {
      const ctx = radarCtx;
      const w = emotionRadarCanvas.width;
      const h = emotionRadarCanvas.height;
      const centerX = w / 2;
      const centerY = h / 2;
      const maxR = Math.min(w, h) / 2 - 10;

      ctx.clearRect(0, 0, w, h);

      // grid circles
      ctx.strokeStyle = 'rgba(255,255,255,0.1)';
      ctx.lineWidth = 1;
      for (let i = 1; i <= 3; i++) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, (maxR * i) / 3, 0, Math.PI * 2);
        ctx.stroke();
      }

      // axes
      ctx.beginPath();
      ctx.moveTo(centerX - maxR, centerY);
      ctx.lineTo(centerX + maxR, centerY);
      ctx.moveTo(centerX, centerY - maxR);
      ctx.lineTo(centerX, centerY + maxR);
      ctx.stroke();

      // point from valence/arousal
      const angle = (1 - state.arousal) * Math.PI; // top/bottom mapping
      const radius = state.intensity * maxR;
      const x = centerX + Math.cos(angle) * radius * (state.valence * 0.8 + 0.2);
      const y = centerY + Math.sin(angle) * radius;

      ctx.fillStyle = 'rgba(104, 219, 255, 0.9)';
      ctx.beginPath();
      ctx.arc(x, y, 6, 0, Math.PI * 2);
      ctx.fill();
    }

    // ===== TREND DRAW =======================================================
    function drawTrend() {
      const ctx = trendCtx;
      const w = emotionTrendCanvas.width;
      const h = emotionTrendCanvas.height;
      ctx.clearRect(0, 0, w, h);

      // grid line
      ctx.strokeStyle = 'rgba(255,255,255,0.1)';
      ctx.beginPath();
      ctx.moveTo(0, h / 2);
      ctx.lineTo(w, h / 2);
      ctx.stroke();

      if (state.trend.length < 2) return;

      ctx.strokeStyle = 'rgba(120, 200, 255, 0.9)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      const step = w / Math.max(state.trend.length - 1, 1);

      state.trend.forEach((val, i) => {
        const x = i * step;
        const y = h - val * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    // ===== CAMERA SETUP =====================================================
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        cameraVideo.srcObject = stream;
        // video kept hidden for now – later we can overlay face analysis
      } catch (err) {
        console.warn('Camera access denied or failed', err);
        emotionOutputEl.textContent = 'Camera unavailable – live scan running in simulation mode.';
      }
    }

    // ===== VOICE RECOGNITION ===============================================
    function initSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        aiCoachOutput.textContent = 'Voice recognition not supported in this browser.';
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        state.recognizing = true;
        aiCoachOutput.textContent = 'Listening...';
      };

      recognition.onerror = (e) => {
        state.recognizing = false;
        aiCoachOutput.textContent = 'Recognition error: ' + e.error;
      };

      recognition.onend = () => {
        state.recognizing = false;
        if (aiCoachOutput.textContent === 'Listening...') {
          aiCoachOutput.textContent = 'No voice captured.';
        }
      };

      recognition.onresult = (event) => {
        state.recognizing = false;
        const transcript = event.results[0][0].transcript;
        const lower = transcript.toLowerCase();
        aiCoachOutput.textContent = 'You said: "' + transcript + '".';

        // Simple intent / suggestion placeholder
        let suggestion = '';
        if (lower.includes('stress') || lower.includes('overwhelmed')) {
          suggestion = 'Take 60 seconds for slow breathing and one small, concrete next action.';
        } else if (lower.includes('tired') || lower.includes('fatigue')) {
          suggestion = 'Short pause, hydration, and gentle movement will help reset your system.';
        } else if (lower.includes('focus') || lower.includes('work')) {
          suggestion = 'Pick one important task, set a 20-minute focus block, and silence all other inputs.';
        } else {
          suggestion = 'Name how you feel in one word, then choose one tiny action that supports that state.';
        }
        aiCoachOutput.textContent += ' Natasha suggests: ' + suggestion;
      };

      state.speechRecognition = recognition;
    }

    function startListening() {
      if (!state.speechRecognition) {
        initSpeechRecognition();
      }
      if (!state.speechRecognition) return;
      if (state.recognizing) return;
      state.speechRecognition.start();
    }

    // ===== CHALLENGE ========================================================
    function startChallenge() {
      if (state.challengeActive) return;
      state.challengeActive = true;
      state.challengeStart = Date.now();
      challengeButton.textContent = 'Challenge running...';
      challengeButton.disabled = true;
      challengeButton.classList.add('active');

      const duration = 60 * 1000;
      setTimeout(() => {
        state.challengeActive = false;
        const keptCalm = state.currentEmotion === 'Calm' || state.currentEmotion === 'Focus';
        challengeButton.textContent = keptCalm ? 'Calm maintained ✔' : 'Try again';
        challengeButton.disabled = false;
        challengeButton.classList.remove('active');
      }, duration);
    }

    // ===== INTERVALS & INIT ================================================
    function startLive() {
      if (state.running) return;
      state.running = true;
      startCamera();
      // live simulation tick
      setInterval(simulateStep, 2000);
      refreshUI();
    }

    // Scenario button handlers
    document.querySelectorAll('.scenario-button[data-scenario]').forEach(btn => {
      btn.addEventListener('click', () => {
        applyScenario(btn.getAttribute('data-scenario'));
      });
    });

    startLiveButton.addEventListener('click', () => {
      startLive();
      startLiveButton.textContent = 'Live scan running';
      startLiveButton.disabled = true;
    });

    askNatashaButton.addEventListener('click', startListening);
    aiCoachButton.addEventListener('click', startListening);
    challengeButton.addEventListener('click', startChallenge);

    // Basic reveal-on-scroll effect (no external libs)
    const revealEls = document.querySelectorAll('.reveal-on-scroll, .section-stagger');
    function handleScrollReveal() {
      const triggerBottom = window.innerHeight * 0.9;
      revealEls.forEach(el => {
        const rect = el.getBoundingClientRect();
        if (rect.top < triggerBottom) {
          el.classList.add('revealed');
        }
      });
    }
    window.addEventListener('scroll', handleScrollReveal);
    window.addEventListener('load', () => {
      refreshUI();
      initSpeechRecognition();
      handleScrollReveal();
    });
  </script>
</body>
</html>
