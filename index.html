<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURO-CORE ELITE v3.0 - AUTO LAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root {
            --deep-space: #000510;
            --neon-blue: #00e5ff;
            --aura-glow: rgba(0, 229, 255, 0.4);
            --ui-border: rgba(79, 195, 247, 0.3);
            --stress-color: #ff3b3b;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--deep-space); color: #81d4fa;
            font-family: 'Orbitron', sans-serif; overflow: hidden;
        }

        #hud { position: absolute; inset: 0; z-index: 10; pointer-events: none; }
        
        .panel {
            position: absolute; background: rgba(0, 10, 30, 0.85);
            backdrop-filter: blur(15px); border: 1px solid var(--ui-border);
            border-left: 5px solid var(--neon-blue); padding: 20px;
            box-shadow: 0 0 20px var(--aura-glow);
            clip-path: polygon(0 0, 100% 0, 100% 80%, 90% 100%, 0 100%);
            pointer-events: auto;
        }

        #panel-l { top: 30px; left: 30px; width: 250px; }
        #panel-r { top: 30px; right: 30px; text-align: right; width: 250px; }

        .stat-label { font-size: 0.6rem; opacity: 0.6; letter-spacing: 2px; margin-bottom: 5px; }
        .stat-value { font-size: 1.1rem; color: #fff; text-shadow: 0 0 10px var(--neon-blue); margin-bottom: 15px; }

        #final-report {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 450px; background: rgba(0, 15, 40, 0.95);
            border-radius: 10px; padding: 30px; border: 1px solid var(--neon-blue);
            z-index: 1000; backdrop-filter: blur(30px);
            display: none; box-shadow: 0 0 50px rgba(0, 229, 255, 0.4);
            pointer-events: auto; animation: scanFade 0.5s ease-out;
        }

        @keyframes scanFade { from { opacity: 0; transform: translate(-50%, -45%); } to { opacity: 1; transform: translate(-50%, -50%); } }

        .report-header { border-bottom: 1px solid var(--ui-border); padding-bottom: 10px; margin-bottom: 20px; font-weight: bold; color: var(--neon-blue); text-align: center; }
        .report-item { font-family: 'Inter'; font-size: 14px; margin-bottom: 10px; line-height: 1.4; }

        #video-container {
            position: absolute; bottom: 30px; right: 30px;
            width: 240px; height: 180px; border: 1px solid var(--ui-border);
            z-index: 15; overflow: hidden; background: #000;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.3; }
        #face-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }

        #controls {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            z-index: 100; text-align: center;
        }
        .btn {
            background: transparent; border: 1px solid var(--neon-blue);
            color: var(--neon-blue); padding: 12px 35px; font-family: 'Orbitron';
            cursor: pointer; transition: 0.3s; letter-spacing: 3px; margin: 0 10px;
        }
        .btn:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 20px var(--neon-blue); }
        .btn-stop { border-color: var(--stress-color); color: var(--stress-color); }

        #ai-comms {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            width: 80%; text-align: center; color: var(--neon-blue); font-size: 0.8rem;
        }
    </style>
</head>
<body>

<div id="hud">
    <div id="panel-l" class="panel">
        <div class="stat-label">NEURAL SCANNER</div>
        <div id="emo-val" class="stat-value">AWAITING...</div>
        <div class="stat-label">HEART RATE</div>
        <div class="stat-value"><span id="bpm-val">--</span> BPM</div>
    </div>
    <div id="panel-r" class="panel">
        <div class="stat-label">DATA PROGRESS</div>
        <div id="prog-val" class="stat-value">0%</div>
        <div id="drift-val" class="stat-value">STANDBY</div>
    </div>
</div>

<div id="final-report">
    <div class="report-header">NEURAL DIAGNOSTICS COMPLETE</div>
    <div id="report-content" class="report-item"></div>
    <button class="btn" style="margin-top: 20px; width: 100%; font-size: 10px;" onclick="closeReport()">RESTART LINK</button>
</div>

<div id="ai-comms">> SYSTEM READY</div>

<div id="controls">
    <button id="scan-trigger" class="btn" onclick="initSystem()">START SCAN</button>
    <button id="stop-trigger" class="btn btn-stop" style="display:none;" onclick="stopSystem()">TERMINATE</button>
</div>

<div id="video-container">
    <video id="video-feed" autoplay muted playsinline></video>
    <canvas id="face-canvas"></canvas>
</div>



<script>
let scene, camera, renderer, core, rings = [];
let systemActive = false;
let analysisData = [];
let stream = null;
let aiLoop = null;
const ANALYSIS_GOAL = 120; // Automatically ends after 120 successful samples
const MODEL_URL = 'https://raw.githubusercontent.com/vladmandic/face-api/master/model/';

function speak(text) {
    const synth = window.speechSynthesis;
    synth.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    
    // Attempt to find a soft female voice
    const voices = synth.getVoices();
    const femaleVoice = voices.find(v => (v.name.includes('Female') || v.name.includes('Zira') || v.name.includes('Google US English')) && v.lang.includes('en'));
    
    if (femaleVoice) utter.voice = femaleVoice;
    utter.pitch = 1.2; // Slightly higher for a softer, feminine feel
    utter.rate = 0.85; // Slightly slower for elegance
    utter.lang = 'en-US';
    
    synth.speak(utter);
    document.getElementById('ai-comms').innerText = "> " + text.toUpperCase();
}

function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const light = new THREE.PointLight(0xffffff, 2, 100);
    light.position.set(5, 5, 5);
    scene.add(light, new THREE.AmbientLight(0x404040, 2));

    core = new THREE.Mesh(
        new THREE.IcosahedronGeometry(2.5, 15),
        new THREE.MeshPhongMaterial({ color: 0x00e5ff, wireframe: true, transparent: true, opacity: 0.4 })
    );
    scene.add(core);

    for(let i=0; i<2; i++) {
        const ring = new THREE.Mesh(
            new THREE.TorusGeometry(4 + i, 0.01, 16, 100),
            new THREE.MeshBasicMaterial({ color: 0x00e5ff, transparent: true, opacity: 0.2 })
        );
        rings.push(ring);
        scene.add(ring);
    }
    camera.position.z = 10;

    function animate() {
        requestAnimationFrame(animate);
        if (core) {
            core.rotation.y += 0.005;
            rings.forEach((r, i) => r.rotation.z += 0.002 * (i + 1));
        }
        renderer.render(scene, camera);
    }
    animate();
}

async function initSystem() {
    document.getElementById('scan-trigger').style.display = 'none';
    document.getElementById('stop-trigger').style.display = 'inline-block';
    document.getElementById('final-report').style.display = 'none';
    analysisData = [];

    try {
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);

        const video = document.getElementById('video-feed');
        stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;

        video.onloadedmetadata = () => {
            const canvas = document.getElementById('face-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            systemActive = true;
            speak("Neural link established. Processing bio-signals.");
            runAI();
        };
    } catch (err) {
        document.getElementById('ai-comms').innerText = "> ERROR: SENSOR FAILURE";
        document.getElementById('scan-trigger').style.display = 'inline-block';
    }
}

async function runAI() {
    const video = document.getElementById('video-feed');
    aiLoop = setInterval(async () => {
        if (!systemActive) return;
        
        const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 }))
            .withFaceLandmarks().withFaceExpressions();

        if (result) {
            drawNeurolink(result.landmarks);
            const top = Object.keys(result.expressions).reduce((a, b) => result.expressions[a] > result.expressions[b] ? a : b);
            
            document.getElementById('emo-val').innerText = top.toUpperCase();
            document.getElementById('bpm-val').innerText = Math.round(70 + (result.expressions.angry * 25));
            
            core.material.color.lerp(new THREE.Color(top === 'angry' ? 0xff3300 : 0x00e5ff), 0.1);
            
            analysisData.push(top);
            let prog = Math.min(100, Math.round((analysisData.length / ANALYSIS_GOAL) * 100));
            document.getElementById('prog-val').innerText = prog + "%";
            document.getElementById('drift-val').innerText = "SCANNING";

            // AUTOMATIC COMPLETION
            if (analysisData.length >= ANALYSIS_GOAL) {
                stopSystem();
            }
        }
    }, 150);
}

function stopSystem() {
    systemActive = false;
    clearInterval(aiLoop);
    if (stream) stream.getTracks().forEach(track => track.stop());
    
    document.getElementById('scan-trigger').style.display = 'inline-block';
    document.getElementById('stop-trigger').style.display = 'none';
    
    showLaboratoryReport();
}

function showLaboratoryReport() {
    const counts = {};
    analysisData.forEach(e => counts[e] = (counts[e] || 0) + 1);
    const dominant = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
    const diversity = Object.keys(counts).length;

    const reportHTML = `
        <div class="report-item"><b>Primary Emotion:</b> ${dominant.toUpperCase()}</div>
        <div class="report-item"><b>Signal Stability:</b> ${diversity < 3 ? 'High (Consistent)' : 'Varied (Dynamic)'}</div>
        <div class="report-item"><b>Data Points:</b> ${analysisData.length} clusters analyzed.</div>
        <div class="report-item" style="color: #00e5ff; margin-top: 15px; border-top: 1px solid rgba(0,229,255,0.2); padding-top: 10px;">
            <b>AI Insight:</b> Your neural profile during this session indicates a predominantly ${dominant} state. Biosignals remained within optimal parameters for cognitive focus.
        </div>
    `;

    document.getElementById('report-content').innerHTML = reportHTML;
    document.getElementById('final-report').style.display = 'block';
    speak("Scanning complete. Your neural diagnostic report is ready.");
}

function closeReport() {
    document.getElementById('final-report').style.display = 'none';
    document.getElementById('prog-val').innerText = "0%";
    document.getElementById('emo-val').innerText = "AWAITING...";
}

function drawNeurolink(landmarks) {
    const canvas = document.getElementById('face-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const pts = landmarks.positions;
    ctx.strokeStyle = 'rgba(0, 229, 255, 0.4)';
    ctx.lineWidth = 0.8;
    ctx.beginPath();
    for (let i = 0; i < pts.length; i += 4) {
        for (let j = i + 1; j < pts.length; j += 8) {
            const dist = Math.hypot(pts[i].x - pts[j].x, pts[i].y - pts[j].y);
            if (dist < 40) { ctx.moveTo(pts[i].x, pts[i].y); ctx.lineTo(pts[j].x, pts[j].y); }
        }
    }
    ctx.stroke();
}

window.onload = init3D;
</script>
</body>
</html>
