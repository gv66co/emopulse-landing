<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURO-CORE LAB ELITE v3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root {
            --deep-space: #000510;
            --neon-blue: #00e5ff;
            --aura-glow: rgba(0, 229, 255, 0.4);
            --ui-border: rgba(79, 195, 247, 0.3);
            --stress-color: #ff3b3b;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--deep-space); color: #81d4fa;
            font-family: 'Orbitron', sans-serif; overflow: hidden;
        }

        /* HUD Elementai */
        #hud { position: absolute; inset: 0; z-index: 10; pointer-events: none; }
        
        .panel {
            position: absolute; background: rgba(0, 10, 30, 0.85);
            backdrop-filter: blur(15px); border: 1px solid var(--ui-border);
            border-left: 5px solid var(--neon-blue); padding: 20px;
            box-shadow: 0 0 20px var(--aura-glow);
            clip-path: polygon(0 0, 100% 0, 100% 80%, 90% 100%, 0 100%);
            pointer-events: auto;
        }

        #panel-l { top: 30px; left: 30px; width: 250px; }
        #panel-r { top: 30px; right: 30px; text-align: right; width: 250px; }

        .stat-label { font-size: 0.6rem; opacity: 0.6; letter-spacing: 2px; margin-bottom: 5px; }
        .stat-value { font-size: 1.1rem; color: #fff; text-shadow: 0 0 10px var(--neon-blue); margin-bottom: 15px; }

        /* Ataskaitos kortelė */
        .story-card {
            max-width: 500px; margin: 100px auto; background: rgba(255,255,255,0.05);
            border-radius: 20px; padding: 32px; border: 1px solid var(--ui-border);
            position: relative; z-index: 100; backdrop-filter: blur(20px);
            display: none; animation: storyFade 0.5s ease-out;
            pointer-events: auto;
        }
        .story-card::before {
            content: ""; position: absolute; top: 0; left: 0; height: 6px; width: 100%;
            background: linear-gradient(90deg, #3a8dff, #7b5cff, #ff9f1c, #ff3b3b);
        }
        .story-title { font-size: 20px; font-weight: 800; margin-bottom: 16px; color: #fff; }
        .story-text { font-family: 'Inter'; font-size: 15px; line-height: 1.6; color: #81d4fa; }

        /* Kameros langas */
        #video-container {
            position: absolute; bottom: 30px; right: 30px;
            width: 240px; height: 180px; border: 1px solid var(--neon-blue);
            z-index: 15; overflow: hidden; background: #000;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.4; filter: grayscale(1); }
        #face-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }

        /* Valdymas */
        #controls {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            z-index: 100; text-align: center;
        }
        .btn {
            background: transparent; border: 1px solid var(--neon-blue);
            color: var(--neon-blue); padding: 12px 35px; font-family: 'Orbitron';
            cursor: pointer; transition: 0.3s; letter-spacing: 3px; margin: 0 10px;
        }
        .btn:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 20px var(--neon-blue); }
        .btn-stop { border-color: var(--stress-color); color: var(--stress-color); }
        .btn-stop:hover { background: var(--stress-color); color: #fff; box-shadow: 0 0 20px var(--stress-color); }

        #ai-comms {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            width: 80%; text-align: center; color: var(--neon-blue); font-size: 0.8rem;
        }

        @keyframes storyFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="hud">
    <div id="panel-l" class="panel">
        <div class="stat-label">NEURAL STATE</div>
        <div id="emo-val" class="stat-value">OFFLINE</div>
        <div class="stat-label">BIOMETRIC BPM</div>
        <div class="stat-value"><span id="bpm-val">--</span></div>
    </div>
    <div id="panel-r" class="panel">
        <div class="stat-label">SYNC PROGRESS</div>
        <div id="prog-val" class="stat-value">0%</div>
        <div class="stat-label">SYSTEM DRIFT</div>
        <div id="drift-val" class="stat-value">AWAITING</div>
    </div>
</div>

<div id="final-report" class="story-card">
    <div class="story-title">SESSION ANALYSIS REPORT</div>
    <div id="report-text" class="story-text">Procesas baigtas. Duomenys apdoroti.</div>
    <button class="btn" style="margin-top: 20px; font-size: 10px;" onclick="this.parentElement.style.display='none'">CLOSE</button>
</div>

<div id="ai-comms">> INITIALIZE NEURAL LINK TO COMMENCE</div>

<div id="controls">
    <button id="scan-trigger" class="btn" onclick="initSystem()">START SCAN</button>
    <button id="stop-trigger" class="btn btn-stop" style="display:none;" onclick="stopSystem()">TERMINATE</button>
</div>

<div id="video-container">
    <video id="video-feed" autoplay muted playsinline></video>
    <canvas id="face-canvas"></canvas>
</div>



<script>
/* --- GLOBALŪS KINTAMIEJI --- */
let scene, camera, renderer, core, rings = [];
let systemActive = false;
let analysisData = [];
let stream = null;
let aiLoop = null;
const ANALYSIS_THRESHOLD = 150; 
const MODEL_URL = 'https://raw.githubusercontent.com/vladmandic/face-api/master/model/';

const EMOTION_THEMES = {
    neutral:  { color: 0x00e5ff, speed: 0.005, scale: 1.0 },
    happy:    { color: 0x00ff88, speed: 0.015, scale: 1.3 },
    sad:      { color: 0x0066ff, speed: 0.002, scale: 0.9 },
    angry:    { color: 0xff3300, speed: 0.040, scale: 1.2 },
    surprised:{ color: 0xffdd00, speed: 0.020, scale: 1.4 }
};

/* --- 1. BALSAS --- */
function speak(text) {
    const synth = window.speechSynthesis;
    synth.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.pitch = 1.1; utter.rate = 0.9;
    synth.speak(utter);
    document.getElementById('ai-comms').innerText = "> ANALYSIS: " + text;
}

/* --- 2. 3D BRANDUOLYS --- */
function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const light = new THREE.PointLight(0xffffff, 2, 100);
    light.position.set(5, 5, 5);
    scene.add(light, new THREE.AmbientLight(0x404040, 2));

    const geometry = new THREE.IcosahedronGeometry(2.5, 15);
    const material = new THREE.MeshPhongMaterial({ color: 0x00e5ff, wireframe: true, transparent: true, opacity: 0.4 });
    core = new THREE.Mesh(geometry, material);
    scene.add(core);

    for(let i=0; i<2; i++) {
        const rGeo = new THREE.TorusGeometry(4 + i, 0.01, 16, 100);
        const rMat = new THREE.MeshBasicMaterial({ color: 0x00e5ff, transparent: true, opacity: 0.2 });
        const ring = new THREE.Mesh(rGeo, rMat);
        rings.push(ring);
        scene.add(ring);
    }
    camera.position.z = 10;

    function animate() {
        requestAnimationFrame(animate);
        if (core) {
            core.rotation.y += 0.005;
            rings.forEach((r, i) => r.rotation.z += 0.002 * (i + 1));
        }
        renderer.render(scene, camera);
    }
    animate();
}

function updateVisuals(emotion, intensity) {
    if (!core) return;
    const theme = EMOTION_THEMES[emotion] || EMOTION_THEMES.neutral;
    core.material.color.lerp(new THREE.Color(theme.color), 0.05);
    const pulse = 1 + (Math.sin(Date.now() * 0.005) * 0.05);
    const targetScale = theme.scale * pulse;
    core.scale.lerp(new THREE.Vector3(targetScale, targetScale, targetScale), 0.1);
}

/* --- 3. SKENAVIMO LOGIKA --- */
async function initSystem() {
    if (systemActive) return;
    document.getElementById('scan-trigger').style.display = 'none';
    document.getElementById('stop-trigger').style.display = 'inline-block';
    document.getElementById('final-report').style.display = 'none';
    analysisData = [];

    try {
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);

        const video = document.getElementById('video-feed');
        stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;

        video.onloadedmetadata = () => {
            const canvas = document.getElementById('face-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            systemActive = true;
            speak("Neural interface online. Commencing biometric scan.");
            runAI();
        };
    } catch (err) {
        document.getElementById('ai-comms').innerText = "> ERROR: CAMERA ACCESS DENIED.";
        document.getElementById('scan-trigger').style.display = 'inline-block';
    }
}

async function runAI() {
    const video = document.getElementById('video-feed');
    aiLoop = setInterval(async () => {
        if (!systemActive) return;
        const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 }))
            .withFaceLandmarks().withFaceExpressions();

        if (result) {
            drawNeurolink(result.landmarks);
            const top = Object.keys(result.expressions).reduce((a, b) => result.expressions[a] > result.expressions[b] ? a : b);
            
            document.getElementById('emo-val').innerText = top.toUpperCase();
            document.getElementById('bpm-val').innerText = Math.round(68 + (result.expressions.angry * 30));
            
            updateVisuals(top, result.expressions[top]);
            
            analysisData.push(top);
            const progress = Math.min(100, Math.round((analysisData.length / ANALYSIS_THRESHOLD) * 100));
            document.getElementById('prog-val').innerText = progress + "%";
            document.getElementById('drift-val').innerText = progress < 100 ? "ANALYZING" : "SYNCED";

            if (analysisData.length === ANALYSIS_THRESHOLD) {
                speak("Neural baseline established. Data synthesis complete.");
            }
        }
    }, 150);
}

function stopSystem() {
    systemActive = false;
    clearInterval(aiLoop);
    if (stream) stream.getTracks().forEach(track => track.stop());
    
    document.getElementById('scan-trigger').style.display = 'inline-block';
    document.getElementById('stop-trigger').style.display = 'none';
    document.getElementById('emo-val').innerText = "OFFLINE";
    
    generateFinalReport();
}

function generateFinalReport() {
    if (analysisData.length === 0) return;
    const counts = {};
    analysisData.forEach(e => counts[e] = (counts[e] || 0) + 1);
    const dominant = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);

    const insights = {
        happy: "Jūsų būsena rodo optimalią neuralinę harmoniją. Dopamino lygis skatina kūrybinį mąstymą.",
        neutral: "Sistemos stabilumas pasiektas. Jūsų kognityvinė apkrova yra minimali, o tai idealu giliam darbui.",
        sad: "Užfiksuotas dažnio kritimas. Rekomenduojama atlikti aplinkos recalibraciją arba trumpą pertrauką.",
        angry: "Neuralinė trintis aptikta. Jūsų bio-signalai rodo aukštą įtampą, rekomenduojama stabilizuoti kvėpavimą.",
        surprised: "Aukštas kognityvinis sužadinimas. Jūsų neuralinis laukas reaguoja į naujus dirgiklius itin aktyviai."
    };

    document.getElementById('report-text').innerText = insights[dominant] || "Analizė baigta.";
    document.getElementById('final-report').style.display = 'block';
    speak("Session terminated. Neural report ready.");
}

function drawNeurolink(landmarks) {
    const canvas = document.getElementById('face-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const pts = landmarks.positions;
    ctx.strokeStyle = 'rgba(0, 229, 255, 0.3)';
    ctx.lineWidth = 0.5;
    ctx.beginPath();
    for (let i = 0; i < pts.length; i += 2) {
        for (let j = i + 1; j < pts.length; j += 4) {
            const dist = Math.hypot(pts[i].x - pts[j].x, pts[i].y - pts[j].y);
            if (dist < 30) { ctx.moveTo(pts[i].x, pts[i].y); ctx.lineTo(pts[j].x, pts[j].y); }
        }
    }
    ctx.stroke();
}

window.onload = init3D;
</script>
</body>
</html>
