import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";

let scene, camera, renderer, controls, group;
let slides = [];
let currentIndex = 0;
let isPaused = false;

// Skaidrių sąrašas - įsitikink, kad šie failai yra aplanke /slides/
const slideImages = [
    'slides/slide1.jpg',
    'slides/slide2.jpg',
    'slides/slide3.jpg',
    'slides/slide4.jpg',
    'slides/team.jpg' // Arvid Pak skaidrė
];

const slideLabels = [
    "Problem & Vision",
    "Solution Technology",
    "Market Analysis",
    "Business Model",
    "Founder: Arvid Pak"
];

function init() {
    const canvas = document.getElementById('deck3d');
    if (!canvas) return;

    // --- SCENE ---
    scene = new THREE.Scene();
    
    camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
    camera.position.set(0, 0, 10);

    renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

    // --- CONTROLS ---
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.5;

    // --- GROUP FOR CAROUSEL ---
    group = new THREE.Group();
    scene.add(group);

    // --- LOAD SLIDES ---
    const loader = new THREE.TextureLoader();
    const radius = 5;

    slideImages.forEach((url, i) => {
        loader.load(url, (texture) => {
            const geometry = new THREE.PlaneGeometry(4, 2.5);
            const material = new THREE.MeshBasicMaterial({ 
                map: texture, 
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.9 
            });
            const mesh = new THREE.Mesh(geometry, material);

            const angle = (i / slideImages.length) * Math.PI * 2;
            mesh.position.set(Math.cos(angle) * radius, 0, Math.sin(angle) * radius);
            mesh.lookAt(0, 0, 0);
            
            group.add(mesh);
            slides.push(mesh);

            if (i === 0) updateLabel(0);
        });
    });

    // --- LIGHTS ---
    scene.add(new THREE.AmbientLight(0xffffff, 1));

    // --- EVENTS ---
    document.getElementById('next')?.addEventListener('click', () => navigate(1));
    document.getElementById('prev')?.addEventListener('click', () => navigate(-1));
    document.getElementById('pause')?.addEventListener('click', togglePause);

    window.addEventListener('resize', onWindowResize);
    animate();
}

function navigate(dir) {
    currentIndex = (currentIndex + dir + slideImages.length) % slideImages.length;
    const targetRotation = -(currentIndex / slideImages.length) * Math.PI * 2;
    
    // Paprastas sukimasis link pasirinktos skaidrės
    group.rotation.y = targetRotation;
    updateLabel(currentIndex);
}

function updateLabel(index) {
    const labelEl = document.getElementById('slideLabel');
    if (labelEl) labelEl.textContent = slideLabels[index] || `Slide ${index + 1}`;
}

function togglePause() {
    isPaused = !isPaused;
    controls.autoRotate = !isPaused;
    const btn = document.getElementById('pause');
    if (btn) btn.textContent = isPaused ? "Play" : "Pause";
}

function onWindowResize() {
    const canvas = document.getElementById('deck3d');
    camera.aspect = canvas.clientWidth / canvas.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

// Paleidžiame kai Three.js jau yra užkrautas per HTML
window.addEventListener('load', () => {
    if (window.THREE) init();
});
